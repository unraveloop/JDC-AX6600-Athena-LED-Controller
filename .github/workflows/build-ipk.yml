name: Build LuCI IPK

on:
  release:
    types: [published]
  workflow_dispatch: # 允许手动点击触发

jobs:
  build_ipk:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许上传文件到 Release

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Prepare OpenWrt SDK
      run: |
        # 下载适用于 AX6600 (IPQ60xx) 的 SDK (这里使用 OpenWrt 23.05.2 稳定版)
        echo "Downloading SDK..."
        wget https://downloads.openwrt.org/releases/23.05.5/targets/ipq60xx/generic/openwrt-sdk-23.05.5-ipq60xx-generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz
        
        echo "Extracting SDK..."
        tar -xf openwrt-sdk-*.tar.xz
        # 重命名解压后的目录方便后续操作
        mv openwrt-sdk-* sdk
        
    - name: Update Feeds & Install Package
      working-directory: ./sdk
      run: |
        # 更新基础依赖源
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 将我们的源码链接到 SDK 的 package 目录
        # 注意：$GITHUB_WORKSPACE 是当前项目根目录
        ln -s $GITHUB_WORKSPACE/luci-app-athena-led package/luci-app-athena-led
        
    - name: Compile IPK
      working-directory: ./sdk
      run: |
        # 预先下载依赖 (这一步会触发 Makefile 去下载你的 Rust tar.gz)
        make package/luci-app-athena-led/download V=s
        
        # 开始编译
        # V=s 显示详细日志，-j$(nproc) 使用多核编译
        make package/luci-app-athena-led/compile V=s -j$(nproc)

    - name: Find & Organize IPK
      run: |
        mkdir -p output_ipk
        # 查找生成的 ipk 文件并移动到输出目录
        find sdk/bin/packages -name "luci-app-athena-led_*.ipk" -exec mv {} output_ipk/ \;
        echo "Found IPK files:"
        ls -l output_ipk/

    - name: Upload IPK to Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: output_ipk/*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
