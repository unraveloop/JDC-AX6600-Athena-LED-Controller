name: Build Rust Binary (Zigbuild)

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build_rust:
    name: Compile Rust (athena-led)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-musl

      # 1. å®‰è£… zigbuild (è¿™ä¸€æ­¥æ¯”å®‰è£… Cross å¿«å¾—å¤šï¼Œä¸”ä¸éœ€è¦ Docker)
      - name: Install Zigbuild
        run: |
          pip3 install cargo-zigbuild ziglang
          
      # 2. ç¼–è¯‘ (ç›´æ¥ä½¿ç”¨ zigbuildï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç† musl çš„ C åº“ä¾èµ–)
      - name: Compile with Zigbuild
        working-directory: ./athena-led
        run: |
          echo "ğŸš€ Building with Zigbuild..."
          cargo zigbuild --release --target aarch64-unknown-linux-musl
          
          echo "âœ… Build success! Checking output..."
          ls -l target/aarch64-unknown-linux-musl/release/

      - name: Compress Binary
        working-directory: ./athena-led
        run: |
          mkdir -p dist
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          cp target/aarch64-unknown-linux-musl/release/athena-led dist/
          
          # æ‰“åŒ…
          cd dist
          tar -czvf ../athena-led-aarch64-unknown-linux-musl.tar.gz athena-led

      - name: Upload Binary to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name || 'v1.0.0' }}
          files: athena-led/athena-led-aarch64-unknown-linux-musl.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
