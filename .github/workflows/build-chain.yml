name: Build Chain (Rust Binary + IPK + APK)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ðŸŸ¢ ç¬¬ä¸€é˜¶æ®µï¼šç¼–è¯‘ Rust æ ¸å¿ƒäºŒè¿›åˆ¶
  build_rust:
    name: 1. Build Rust Core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. ðŸ” [æ™ºèƒ½ä¿®å¤] è‡ªåŠ¨æŸ¥æ‰¾ Makefile è¯»å–ç‰ˆæœ¬å·
      # ä¸å†å†™æ­»è·¯å¾„ï¼Œå…¼å®¹æ ¹ç›®å½•æˆ–å­ç›®å½•ç»“æž„
      - name: Get Version
        id: version
        run: |
          # æŸ¥æ‰¾åä¸º Makefile çš„æ–‡ä»¶ï¼Œä¸”å†…å®¹åŒ…å« PKG_VERSION
          MAKEFILE_PATH=$(find . -name "Makefile" -print0 | xargs -0 grep -l "PKG_VERSION:=" | head -n 1)
          
          if [ -z "$MAKEFILE_PATH" ]; then
            echo "âš ï¸ Makefile not found, using default version 1.0.0"
            PKG_VERSION="1.0.0"
          else
            PKG_VERSION=$(grep "PKG_VERSION:=" "$MAKEFILE_PATH" | cut -d"=" -f2 | tr -d '[:space:]')
            echo "âœ… Found version $PKG_VERSION in $MAKEFILE_PATH"
          fi
          
          echo "VERSION=$PKG_VERSION" >> $GITHUB_OUTPUT

      # 2. å‡†å¤‡ Rust çŽ¯å¢ƒ
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-musl

      # 3. å®‰è£… Zig (è§£å†³ ring ç¼–è¯‘æŠ¥é”™)
      - name: Install Zig & Zigbuild
        run: |
          pip3 install cargo-zigbuild ziglang

      # 4. ç¼–è¯‘ Rust
      - name: Compile Rust
        working-directory: ./athena-led
        run: |
          cargo zigbuild --release --target aarch64-unknown-linux-musl

      # 5. æ‰“åŒ…äºŒè¿›åˆ¶
      - name: Package Binary
        id: package
        working-directory: ./athena-led
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          FILENAME="athena-led-${VERSION}.tar.gz"
          
          mkdir -p dist
          cp target/aarch64-unknown-linux-musl/release/athena-led dist/
          
          cd dist
          tar -czvf ../$FILENAME athena-led
          
          echo "ASSET_NAME=$FILENAME" >> $GITHUB_OUTPUT
          echo "âœ… Packed binary: $FILENAME"

      # 6. ä¸Šä¼  Rust äºŒè¿›åˆ¶
      - name: Upload Rust Binary to Release
        uses: softprops/action-gh-release@v1
        with:
          files: athena-led/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. ä¼ é€’ç»™ OpenWrt ä»»åŠ¡
      - name: Pass Artifact to Next Job
        uses: actions/upload-artifact@v4
        with:
          name: rust-binary-tarball
          path: athena-led/*.tar.gz
          retention-days: 1

  # ðŸ”µ ç¬¬äºŒé˜¶æ®µï¼šç¼–è¯‘ OpenWrt å®‰è£…åŒ…
  build_openwrt:
    name: 2. Build ${{ matrix.type }}
    needs: build_rust
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - type: ipk
            name: Stable (23.05)
            sdk_url: "https://downloads.openwrt.org/releases/23.05.5/targets/ipq807x/generic"
            use_apk: false
          - type: apk
            name: Snapshot (Qualcommax)
            sdk_url: "https://downloads.openwrt.org/snapshots/targets/qualcommax/ipq60xx"
            use_apk: true

    steps:
      - uses: actions/checkout@v4

      - name: Download Rust Artifact
        uses: actions/download-artifact@v4
        with:
          name: rust-binary-tarball
          path: local_dl/

      - name: Prepare SDK
        run: |
          sudo apt-get update && sudo apt-get install -y zstd
          
          BASE_URL="${{ matrix.sdk_url }}"
          SDK_FILE=$(wget -qO- "$BASE_URL/sha256sums" | grep "sdk" | grep "Linux-x86_64" | head -n 1 | awk '{print $2}' | sed 's/*//g')
          wget -q "$BASE_URL/$SDK_FILE"
          
          if [[ "$SDK_FILE" == *.zst ]]; then 
            zstd -d "$SDK_FILE" -o sdk.tar
            tar -xf sdk.tar
          else 
            tar -xf "$SDK_FILE"
          fi
          
          # [æ™ºèƒ½ä¿®å¤] æŸ¥æ‰¾è§£åŽ‹åŽçš„ç›®å½• (ä¿®å¤ mv æŠ¥é”™)
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -n 1)
          mv "$EXTRACTED_DIR" sdk

      - name: Inject Source into SDK
        run: |
          mkdir -p sdk/dl
          cp local_dl/*.tar.gz sdk/dl/

      - name: Configure Feeds
        working-directory: ./sdk
        run: |
          sed -i 's|git.openwrt.org/openwrt/openwrt.git|github.com/openwrt/openwrt.git|g' feeds.conf.default
          sed -i 's|git.openwrt.org/feed/packages.git|github.com/openwrt/packages.git|g' feeds.conf.default
          sed -i 's|git.openwrt.org/project/luci.git|github.com/openwrt/luci.git|g' feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # âš ï¸ [æ™ºèƒ½ä¿®å¤] è‡ªåŠ¨æŸ¥æ‰¾æºç ç›®å½•å¹¶åˆ›å»ºé“¾æŽ¥
      - name: Compile Package
        working-directory: ./sdk
        run: |
          # 1. åœ¨ GitHub Workspace ä¸­æŸ¥æ‰¾æºç ç›®å½• (å…¼å®¹æ ¹ç›®å½•æˆ– package/ ç›®å½•)
          # è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šæ‰¾ä¸€ä¸ªå« luci-app-athena-led çš„æ–‡ä»¶å¤¹
          LUCI_SRC=$(find $GITHUB_WORKSPACE -type d -name "luci-app-athena-led" | head -n 1)
          
          if [ -z "$LUCI_SRC" ]; then
             echo "âŒ Error: Could not find 'luci-app-athena-led' directory!"
             find $GITHUB_WORKSPACE -maxdepth 2
             exit 1
          fi
          
          echo "ðŸ”— Found source at: $LUCI_SRC"
          echo "ðŸ”— Linking to: package/luci-app-athena-led"
          
          # 2. åˆ›å»ºè½¯é“¾æŽ¥
          ln -s "$LUCI_SRC" package/luci-app-athena-led
          
          # 3. å†™å…¥é…ç½®
          echo "CONFIG_PACKAGE_luci-app-athena-led=m" > .config
          if [ "${{ matrix.use_apk }}" = "true" ]; then
             echo "CONFIG_SIGNED_PACKAGES=y" >> .config
          fi
          
          make defconfig
          
          # 4. ç¼–è¯‘
          make package/luci-app-athena-led/download V=s
          make package/luci-app-athena-led/compile V=s -j$(nproc)

      - name: Upload Package to Release
        uses: softprops/action-gh-release@v1
        with:
          files: sdk/bin/**/luci-app-athena-led*.${{ matrix.type }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
