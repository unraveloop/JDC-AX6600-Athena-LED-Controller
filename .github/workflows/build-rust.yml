name: Build Rust Binary (Fixed Path)

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build_rust:
    name: Compile Rust (athena-led)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ğŸ” è°ƒè¯•æ­¥éª¤ï¼šç¡®è®¤ Cargo.toml çœŸçš„å­˜åœ¨
      - name: Verify Directory Structure
        run: |
          echo "Listing athena-led directory:"
          ls -l athena-led/ || echo "âŒ Directory not found!"
          
          if [ ! -f "athena-led/Cargo.toml" ]; then
            echo "âŒ Error: athena-led/Cargo.toml does not exist."
            exit 1
          fi

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-musl

      - name: Install Cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cross Compile
        # âš ï¸ å…³é”®ä¿®å¤ï¼šå»æ‰ working-directoryï¼Œåœ¨æ ¹ç›®å½•è¿è¡Œ
        # ä½¿ç”¨ --manifest-path æŒ‡å‘å­ç›®å½•çš„ Cargo.toml
        run: |
          echo "Building from root using manifest path..."
          cross build --release --target aarch64-unknown-linux-musl --manifest-path athena-led/Cargo.toml
          
          # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
          # æ³¨æ„ï¼šå¦‚æœ athena-led æ˜¯ç‹¬ç«‹é¡¹ç›®ï¼Œtarget ç›®å½•é€šå¸¸ä¼šåœ¨ athena-led/target
          # å¦‚æœå®ƒæ˜¯ workspace çš„ä¸€éƒ¨åˆ†ï¼Œtarget å¯èƒ½åœ¨æ ¹ç›®å½• ./target
          echo "Checking for binary..."
          find . -name "athena-led" -type f | grep "release"

      - name: Compress Binary
        run: |
          mkdir -p dist
          
          # ä½¿ç”¨ find å‘½ä»¤æŸ¥æ‰¾å¹¶å¤åˆ¶ï¼Œé˜²æ­¢è·¯å¾„çŒœé”™
          # -name ä½ çš„äºŒè¿›åˆ¶åå­— (æ ¹æ® Cargo.toml é‡Œçš„ package.nameï¼Œé€šå¸¸æ˜¯æ–‡ä»¶å¤¹å athena-led)
          BINARY_PATH=$(find athena-led/target -name "athena-led" -type f | grep "aarch64-unknown-linux-musl/release" | head -n 1)
          
          if [ -z "$BINARY_PATH" ]; then
             echo "âŒ Build failed or binary not found!"
             ls -R athena-led/target
             exit 1
          fi
          
          echo "Found binary at: $BINARY_PATH"
          cp "$BINARY_PATH" dist/
          
          # æ‰“åŒ…
          cd dist
          tar -czvf athena-led-aarch64-unknown-linux-musl.tar.gz athena-led
          
          echo "ğŸ“¦ Packaging complete!"

      - name: Upload Binary to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name || 'v1.0.0' }}
          files: dist/athena-led-aarch64-unknown-linux-musl.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
