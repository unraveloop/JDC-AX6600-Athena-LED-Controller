name: Build Rust Binary (Subdirectory)

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build_rust:
    name: Compile Rust (athena-led)
    runs-on: ubuntu-latest
    permissions:
      contents: write # å…è®¸ä¸Šä¼  Release é™„ä»¶

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-musl

      - name: Install Cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cross Compile
        # âš ï¸ å…³é”®ä¿®æ”¹ï¼šæŒ‡å®š Rust é¡¹ç›®æ‰€åœ¨çš„å­ç›®å½•
        working-directory: ./athena-led
        run: |
          echo "Building in $(pwd)..."
          cross build --release --target aarch64-unknown-linux-musl
          
          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶ (è·¯å¾„æ˜¯ç›¸å¯¹äº athena-led ç›®å½•çš„)
          ls -l target/aarch64-unknown-linux-musl/release/

      - name: Compress Binary
        # åŒæ ·æŒ‡å®šå·¥ä½œç›®å½•ï¼Œæ–¹ä¾¿è·¯å¾„æ“ä½œ
        working-directory: ./athena-led
        run: |
          # å‡†å¤‡æ‰“åŒ…ç›®å½•
          mkdir -p dist
          
          # å¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ (å‡è®¾ä½ çš„ crate åå­—å« athena-led)
          # å¦‚æœä½ çš„ Cargo.toml é‡Œ name = "xxx"ï¼Œè¿™é‡Œä¹Ÿè¦æ”¹
          cp target/aarch64-unknown-linux-musl/release/athena-led dist/
          
          # è¿›å…¥ dist ç›®å½•æ‰“åŒ…ï¼Œé¿å…å‹ç¼©åŒ…é‡ŒåŒ…å«é•¿è·¯å¾„
          cd dist
          tar -czvf ../athena-led-aarch64-unknown-linux-musl.tar.gz athena-led
          
          echo "ğŸ“¦ Packaging complete!"

      - name: Upload Binary to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name || 'v1.0.0' }}
          # ä¸Šä¼  athena-led ç›®å½•ä¸‹çš„å‹ç¼©åŒ…
          files: athena-led/athena-led-aarch64-unknown-linux-musl.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
