name: Build LuCI IPK

on:
  release:
    types: [published]
  workflow_dispatch: # 允许手动点击触发

jobs:
  build_ipk:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 必须有这个权限才能上传文件到 Release

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Prepare OpenWrt SDK (IPQ807x/Compatible)
      run: |
        # ---------------------------------------------------------------------
        # 使用 OpenWrt 23.05.5 (ipq807x) SDK
        #以此替代 ipq60xx，因为两者架构均为 aarch64_cortex-a53，且 ipq807x 源更稳定
        # ---------------------------------------------------------------------
        BASE_URL="https://downloads.openwrt.org/releases/23.05.5/targets/ipq807x/generic"
        
        echo "Fetching SDK filename from $BASE_URL..."
        
        # 1. 动态获取 SDK 文件名 (避免因 GCC 版本号变更导致 404)
        # 下载 sha256sums -> 筛选包含 "sdk" 和 "Linux-x86_64" 的行 -> 提取文件名
        SDK_FILE=$(wget -qO- "$BASE_URL/sha256sums" | grep "sdk" | grep "Linux-x86_64" | head -n 1 | awk '{print $2}' | sed 's/*//g')
        
        if [ -z "$SDK_FILE" ]; then
          echo "Error: Could not find SDK filename from official repo!"
          exit 1
        fi
        
        echo "Found SDK file: $SDK_FILE"
        
        # 2. 下载 SDK
        wget -q "$BASE_URL/$SDK_FILE"
        
        # 3. 解压
        echo "Extracting..."
        tar -xf "$SDK_FILE"
        
        # 4. 重命名解压后的目录为 'sdk'，方便后续操作
        # 使用 ls -d 匹配解压出来的文件夹名
        EXTRACTED_DIR=$(tar -tf "$SDK_FILE" | head -n 1 | cut -f1 -d"/")
        mv "$EXTRACTED_DIR" sdk
        
        echo "SDK prepared successfully!"

    - name: Update Feeds & Install Package
      working-directory: ./sdk
      run: |
        echo "Updating feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 将你的源码目录链接到 SDK 的 package 目录下
        echo "Linking package..."
        ln -s $GITHUB_WORKSPACE/luci-app-athena-led package/luci-app-athena-led

    - name: Compile IPK
      working-directory: ./sdk
      run: |
        # 1. 【关键修改】强制在 SDK 配置中启用我们的插件 (设置为 m 代表编译为模块)
        echo "CONFIG_PACKAGE_luci-app-athena-led=m" > .config
        
        # 2. 补全依赖配置 (这一步会根据上面的 .config 自动处理所有依赖关系)
        make defconfig
        
        # 3. 预先下载依赖 (这一步会根据 Makefile 去你的 Release 页面下载 Rust 包)
        echo "Downloading dependencies..."
        make package/luci-app-athena-led/download V=s
        
        # 4. 执行真正的编译工作
        echo "Compiling luci-app-athena-led..."
        make package/luci-app-athena-led/compile V=s -j$(nproc)

    - name: Find & Organize IPK
      run: |
        mkdir -p output_ipk
        # 查找生成的 ipk 文件并移动到输出目录
        # 注意：ipq807x SDK 生成的路径通常包含 aarch64_cortex-a53
        find sdk/bin/packages -name "luci-app-athena-led_*.ipk" -exec mv {} output_ipk/ \;
        
        echo "Found IPK files:"
        ls -l output_ipk/

    - name: Upload IPK to Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: output_ipk/*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
