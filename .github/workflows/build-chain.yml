name: Build Chain (Rust Binary + IPK + APK)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ğŸŸ¢ ç¬¬ä¸€é˜¶æ®µï¼šç¼–è¯‘ Rust æ ¸å¿ƒäºŒè¿›åˆ¶
  build_rust:
    name: 1. Build Rust Core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. è‡ªåŠ¨è¯»å–ç‰ˆæœ¬å· (ç”¨äºå‘½å)
      - name: Get Version
        id: version
        run: |
          # å°è¯•ä» Makefile è¯»å–ç‰ˆæœ¬å·ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ 1.0.0
          PKG_VERSION=$(grep "PKG_VERSION:=" package/luci-app-athena-led/Makefile 2>/dev/null | cut -d"=" -f2 || echo "1.0.0")
          echo "VERSION=$PKG_VERSION" >> $GITHUB_OUTPUT

      # 2. å‡†å¤‡ Rust ç¯å¢ƒ
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-musl

      # 3. ç¼–è¯‘ (æ³¨æ„ï¼šè¿™é‡Œå‡è®¾æºç åœ¨ athena-led ç›®å½•ï¼Œä¸” Edition æ˜¯ 2021)
      - name: Compile Rust
        working-directory: ./athena-led
        run: |
          cargo build --release --target aarch64-unknown-linux-musl

      # 4. æ‰“åŒ…äºŒè¿›åˆ¶ (å…³é”®ï¼šè¿™ä¼šç”Ÿæˆ athena-led-1.0.0.tar.gz)
      - name: Package Binary
        id: package
        working-directory: ./athena-led
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          FILENAME="athena-led-${VERSION}.tar.gz"
          
          mkdir -p dist
          # åªå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸åŒ…å«æºç 
          cp target/aarch64-unknown-linux-musl/release/athena-led dist/
          
          cd dist
          tar -czvf ../$FILENAME athena-led
          
          echo "ASSET_NAME=$FILENAME" >> $GITHUB_OUTPUT
          echo "âœ… Packed binary: $FILENAME"

      # 5. [å…³é”®] ä¸Šä¼  Rust äºŒè¿›åˆ¶åˆ° Release
      - name: Upload Rust Binary to Release
        uses: softprops/action-gh-release@v1
        with:
          files: athena-led/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. ä¸Šä¼ å·¥ä»¶ (ç»™åç»­ OpenWrt ç¼–è¯‘ä»»åŠ¡ä½¿ç”¨)
      - name: Pass Artifact to Next Job
        uses: actions/upload-artifact@v4
        with:
          name: rust-binary-tarball
          path: athena-led/*.tar.gz
          retention-days: 1

  # ğŸ”µ ç¬¬äºŒé˜¶æ®µï¼šç¼–è¯‘ OpenWrt å®‰è£…åŒ… (IPK & APK)
  build_openwrt:
    name: 2. Build ${{ matrix.type }}
    needs: build_rust  # å¿…é¡»ç­‰å¾… Rust ç¼–è¯‘å®Œæˆ
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - type: ipk
            name: Stable (23.05)
            sdk_url: "https://downloads.openwrt.org/releases/23.05.5/targets/ipq807x/generic"
            use_apk: false
          - type: apk
            name: Snapshot (Qualcommax)
            sdk_url: "https://downloads.openwrt.org/snapshots/targets/qualcommax/ipq60xx"
            use_apk: true

    steps:
      - uses: actions/checkout@v4

      # 1. ä¸‹è½½åˆšæ‰ç¼–è¯‘å¥½çš„ Rust åŒ…
      - name: Download Rust Artifact
        uses: actions/download-artifact@v4
        with:
          name: rust-binary-tarball
          path: local_dl/

      # 2. å‡†å¤‡ SDK
      - name: Prepare SDK
        run: |
          sudo apt-get update && sudo apt-get install -y zstd
          
          BASE_URL="${{ matrix.sdk_url }}"
          SDK_FILE=$(wget -qO- "$BASE_URL/sha256sums" | grep "sdk" | grep "Linux-x86_64" | head -n 1 | awk '{print $2}' | sed 's/*//g')
          wget -q "$BASE_URL/$SDK_FILE"
          
          # æ™ºèƒ½è§£å‹
          if [[ "$SDK_FILE" == *.zst ]]; then zstd -d "$SDK_FILE" -o sdk.tar; tar -xf sdk.tar; else tar -xf "$SDK_FILE"; fi
          EXTRACTED_DIR=$(tar -tf sdk.tar 2>/dev/null || tar -tf "$SDK_FILE" | head -n 1 | cut -f1 -d"/")
          mv "$EXTRACTED_DIR" sdk

      # 3. æ³¨å…¥ Rust åŒ…åˆ° SDK (è·³è¿‡ä¸‹è½½)
      - name: Inject Source into SDK
        run: |
          mkdir -p sdk/dl
          cp local_dl/*.tar.gz sdk/dl/
          echo "âœ… Injected Rust binary into sdk/dl/"

      # 4. æ›´æ–° Feeds (ä½¿ç”¨ GitHub é•œåƒåŠ é€Ÿ)
      - name: Configure Feeds
        working-directory: ./sdk
        run: |
          sed -i 's|git.openwrt.org/openwrt/openwrt.git|github.com/openwrt/openwrt.git|g' feeds.conf.default
          sed -i 's|git.openwrt.org/feed/packages.git|github.com/openwrt/packages.git|g' feeds.conf.default
          sed -i 's|git.openwrt.org/project/luci.git|github.com/openwrt/luci.git|g' feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. ç¼–è¯‘ IPK / APK
      - name: Compile Package
        working-directory: ./sdk
        run: |
          ln -s $GITHUB_WORKSPACE/package/luci-app-athena-led package/luci-app-athena-led
          
          echo "CONFIG_PACKAGE_luci-app-athena-led=m" > .config
          if [ "${{ matrix.use_apk }}" = "true" ]; then
             echo "CONFIG_SIGNED_PACKAGES=y" >> .config
          fi
          
          make defconfig
          # å› ä¸º dl ç›®å½•å·²æœ‰æ–‡ä»¶ï¼Œè¿™ä¸€æ­¥ä¼šè‡ªåŠ¨è·³è¿‡ä¸‹è½½
          make package/luci-app-athena-led/download V=s
          make package/luci-app-athena-led/compile V=s -j$(nproc)

      # 6. [å…³é”®] ä¸Šä¼  IPK / APK åˆ° Release
      - name: Upload Package to Release
        uses: softprops/action-gh-release@v1
        with:
          # è‡ªåŠ¨åŒ¹é…ç”Ÿæˆçš„æ–‡ä»¶åç¼€
          files: sdk/bin/**/luci-app-athena-led*.${{ matrix.type }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
