#!/bin/sh /etc/rc.common

START=99
STOP=99
USE_PROCD=1
PROG=/usr/bin/athena-led

check_binary() {
    [ -x "$PROG" ] || return 1
}

start_service() {
    config_load 'athena_led'
    local cfg='general' 

    local enabled
    config_get_bool enabled "$cfg" 'enabled' '0'
    [ "$enabled" -eq 0 ] && return 1

    check_binary || return 1

    # --- 1. 读取所有配置 (基础 + 定时) ---
    local seconds lightLevel option netInterface ipUrl value url \
          weatherCity weatherSource seniverseKey tempFlag \
          enableSleep sleepStart sleepEnd

    # 基础配置
    config_get seconds "$cfg" 'duration' '5'
    config_get lightLevel "$cfg" 'light_level' '5'
    config_get option "$cfg" 'display_order' 'banner time temp dev cpu mem ip weather'
    config_get netInterface "$cfg" 'net_interface' 'br-lan'
    config_get ipUrl "$cfg" 'wan_ip_custom_url' 'http://checkip.amazonaws.com'
    config_get value "$cfg" 'custom_content' 'Roc-Gateway'
    config_get url "$cfg" 'http_url' ''
    config_get httpLength "$cfg" 'http_length' '15'
    config_get weatherCity "$cfg" 'weather_city' 'Shenzhen'
    config_get weatherSource "$cfg" 'weather_source' 'wttr'
    config_get weatherFormat "$cfg" 'weather_format' 'simple'
    config_get seniverseKey "$cfg" 'seniverse_key' ''
    config_get tempFlag "$cfg" 'temp_sensors' '0 1 2 3 4'

    # 定时配置
    config_get_bool enableSleep "$cfg" 'enable_sleep' '0'
    config_get sleepStart "$cfg" 'off_time' ''
    config_get sleepEnd "$cfg" 'on_time' ''

    # 逻辑处理：如果不启用休眠，强制传空字符串，Rust 端收到空字符串则不执行休眠逻辑
    if [ "$enableSleep" -eq 0 ]; then
        sleepStart=""
        sleepEnd=""
    fi

    # --- 2. 启动实例 (必须包含所有参数) ---
    procd_open_instance
    procd_set_param command "$PROG"
    
    # 基础参数
    procd_append_param command --seconds "$seconds"
    procd_append_param command --light-level "$lightLevel"
    procd_append_param command --display-order "$option"
    procd_append_param command --net-interface "$netInterface"
    procd_append_param command --ip-url "$ipUrl"
    procd_append_param command --custom-text "$value"
    procd_append_param command --custom-http-url "$url"
    procd_append_param command --http-length "$httpLength"
    procd_append_param command --weather-city "$weatherCity"
    procd_append_param command --weather-source "$weatherSource"
    procd_append_param command --seniverse-key "$seniverseKey"
    procd_append_param command --weather-format "$weatherFormat"
    procd_append_param command --temp-flag "$tempFlag"
    
    # 定时参数 (必须在 close_instance 之前添加！)
    procd_append_param command --sleep-start "$sleepStart"
    procd_append_param command --sleep-end "$sleepEnd"

    # 守护进程配置
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    
    # --- 3. 结束配置 ---
    procd_close_instance
}

service_triggers() {
    procd_add_reload_trigger "athena_led"
}