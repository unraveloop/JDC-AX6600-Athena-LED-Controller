name: Build LuCI APK (Snapshot)

on:
  release:
    types: [published]
  workflow_dispatch: 

jobs:
  build_apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Prepare OpenWrt SDK (Snapshot-IPQ807x)
      run: |
        # 1. 安装 zstd 解压工具
        sudo apt-get update && sudo apt-get install -y zstd
        
        # 2. 修正为 ipq807x (AArch64 兼容架构)
        BASE_URL="https://downloads.openwrt.org/snapshots/targets/ipq807x/generic"
        
        # 3. 获取最新的 .zst SDK 文件名
        SDK_FILE=$(wget -qO- "$BASE_URL/sha256sums" | grep "sdk" | grep "Linux-x86_64" | head -n 1 | awk '{print $2}' | sed 's/*//g')
        echo "Downloading SDK: $SDK_FILE"
        wget -q "$BASE_URL/$SDK_FILE"
        
        # 4. 使用 zstd 解压
        echo "Extracting SDK..."
        zstd -d "$SDK_FILE" -o sdk_archive.tar
        tar -xf sdk_archive.tar
        
        # 5. 稳健地重命名目录
        EXTRACTED_DIR=$(ls -d openwrt-sdk-*)
        mv "$EXTRACTED_DIR" sdk
        
        echo "SDK prepared successfully!"

    - name: Switch Feeds & Update
      working-directory: ./sdk
      run: |
        # 同样替换为 GitHub 镜像加速
        sed -i 's|https://git.openwrt.org/openwrt/openwrt.git|https://github.com/openwrt/openwrt.git|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/feed/packages.git|https://github.com/openwrt/packages.git|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/project/luci.git|https://github.com/openwrt/luci.git|g' feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Compile APK
      working-directory: ./sdk
      run: |
        ln -s $GITHUB_WORKSPACE/luci-app-athena-led package/luci-app-athena-led
        
        # 强制启用插件
        echo "CONFIG_PACKAGE_luci-app-athena-led=m" > .config
        # 加上此项以确保生成元数据索引（apk 必须）
        echo "CONFIG_SIGNED_PACKAGES=y" >> .config
        
        make defconfig
        
        # 预下载 Rust 二进制
        make package/luci-app-athena-led/download V=s
        
        # 执行编译
        make package/luci-app-athena-led/compile V=s -j$(nproc)

    - name: Organize Artifacts
      run: |
        mkdir -p output_apk
        echo "Searching for .apk files recursively..."
        # 使用递归搜索，解决路径深浅不一的问题
        find sdk/bin/ -name "*.apk" -exec cp -v {} output_apk/ \;
        
        if [ -z "$(ls -A output_apk)" ]; then
           echo "❌ ERROR: No APK files found! Try searching for .ipk as fallback..."
           find sdk/bin/ -name "*.ipk" -exec cp -v {} output_apk/ \;
        fi
        
        ls -l output_apk/

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.release.tag_name || 'v1.0.0' }}
        # 这里的路径改为匹配文件夹内所有内容，更稳健
        files: output_apk/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
