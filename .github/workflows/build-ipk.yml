name: Build LuCI IPK (GitHub Mirror Edition)

on:
  release:
    types: [published]
  workflow_dispatch: # 允许手动点击触发

jobs:
  build_ipk:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Prepare OpenWrt SDK (IPQ807x)
      run: |
        # 使用 23.05.5 稳定版 SDK
        BASE_URL="https://downloads.openwrt.org/releases/23.05.5/targets/ipq807x/generic"
        
        # 动态获取最新的 SDK 文件名
        SDK_FILE=$(wget -qO- "$BASE_URL/sha256sums" | grep "sdk" | grep "Linux-x86_64" | head -n 1 | awk '{print $2}' | sed 's/*//g')
        
        echo "Downloading SDK: $SDK_FILE"
        wget -q "$BASE_URL/$SDK_FILE"
        
        tar -xf "$SDK_FILE"
        EXTRACTED_DIR=$(tar -tf "$SDK_FILE" | head -n 1 | cut -f1 -d"/")
        mv "$EXTRACTED_DIR" sdk

    - name: Switch Feeds to GitHub Mirror
      working-directory: ./sdk
      run: |
        # 将官方 git.openwrt.org 替换为 GitHub 镜像地址，提速 10 倍以上
        sed -i 's|https://git.openwrt.org/openwrt/openwrt.git|https://github.com/openwrt/openwrt.git|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/feed/packages.git|https://github.com/openwrt/packages.git|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/project/luci.git|https://github.com/openwrt/luci.git|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/feed/routing.git|https://github.com/openwrt-routing/packages.git|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/feed/telephony.git|https://github.com/openwrt/telephony.git|g' feeds.conf.default
        
        echo "Feeds switched to GitHub mirrors:"
        cat feeds.conf.default

    - name: Update & Install Feeds
      working-directory: ./sdk
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure and Compile
      working-directory: ./sdk
      run: |
        # 1. 将本地源码放入 SDK
        ln -s $GITHUB_WORKSPACE/luci-app-athena-led package/luci-app-athena-led
        
        # 2. 强制启用该插件
        echo "CONFIG_PACKAGE_luci-app-athena-led=m" > .config
        
        # 3. 补全依赖并预下载 (这会从你的 Release 页面下载 Rust 二进制)
        make defconfig
        make package/luci-app-athena-led/download V=s
        
        # 4. 编译
        make package/luci-app-athena-led/compile V=s -j$(nproc)

    - name: Organize Artifacts
      run: |
        mkdir -p output_ipk
        # 搜索生成的 ipk 文件
        find sdk/bin/packages -name "luci-app-athena-led_*.ipk" -exec mv {} output_ipk/ \;
        ls -l output_ipk/

    - name: Upload IPK to Release
      uses: softprops/action-gh-release@v1
      with:
        # 逻辑：优先使用 Release 触发的标签，如果没有（如手动触发），则使用 v1.0.0
        tag_name: ${{ github.event.release.tag_name || 'v1.0.0' }}
        files: output_ipk/*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
