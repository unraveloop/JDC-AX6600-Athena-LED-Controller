name: Build Chain (Rust Binary + IPK + APK)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ðŸŸ¢ ç¬¬ä¸€é˜¶æ®µï¼šç¼–è¯‘ Rust æ ¸å¿ƒäºŒè¿›åˆ¶
  build_rust:
    name: 1. Build Rust Core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. è‡ªåŠ¨è¯»å–ç‰ˆæœ¬å·
      - name: Get Version
        id: version
        run: |
          PKG_VERSION=$(grep "PKG_VERSION:=" luci-app-athena-led/Makefile 2>/dev/null | cut -d"=" -f2 || echo "1.0.0")
          echo "VERSION=$PKG_VERSION" >> $GITHUB_OUTPUT

      # 2. å‡†å¤‡ Rust çŽ¯å¢ƒ
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-musl

      # 3. âš ï¸ [ä¿®å¤] å®‰è£… Zig å’Œ Zigbuild (ç”¨äºŽç¼–è¯‘ ring çš„ C ä»£ç )
      - name: Install Zig & Zigbuild
        run: |
          pip3 install cargo-zigbuild ziglang
          echo "Zig installed!"

      # 4. âš ï¸ [ä¿®å¤] ä½¿ç”¨ zigbuild ç¼–è¯‘ (æ›¿ä»£ cargo build)
      # å®ƒä¼šè‡ªåŠ¨å¤„ç† C è¯­è¨€çš„äº¤å‰ç¼–è¯‘é—®é¢˜
      - name: Compile Rust
        working-directory: ./athena-led
        run: |
          cargo zigbuild --release --target aarch64-unknown-linux-musl

      # 5. æ‰“åŒ…äºŒè¿›åˆ¶
      - name: Package Binary
        id: package
        working-directory: ./athena-led
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          FILENAME="athena-led-${VERSION}.tar.gz"
          
          mkdir -p dist
          # æ³¨æ„ï¼šzigbuild çš„è¾“å‡ºç›®å½•å’Œæ ‡å‡† build ä¸€æ ·
          cp target/aarch64-unknown-linux-musl/release/athena-led dist/
          
          cd dist
          tar -czvf ../$FILENAME athena-led
          
          echo "ASSET_NAME=$FILENAME" >> $GITHUB_OUTPUT
          echo "âœ… Packed binary: $FILENAME"

      # 6. ä¸Šä¼  Rust äºŒè¿›åˆ¶åˆ° Release
      - name: Upload Rust Binary to Release
        uses: softprops/action-gh-release@v1
        with:
          files: athena-led/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. ä¸Šä¼ å·¥ä»¶ç»™ OpenWrt ä»»åŠ¡
      - name: Pass Artifact to Next Job
        uses: actions/upload-artifact@v4
        with:
          name: rust-binary-tarball
          path: athena-led/*.tar.gz
          retention-days: 1

  # ðŸ”µ ç¬¬äºŒé˜¶æ®µï¼šç¼–è¯‘ OpenWrt å®‰è£…åŒ… (IPK & APK)
  build_openwrt:
    name: 2. Build ${{ matrix.type }}
    needs: build_rust
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - type: ipk
            name: Stable (23.05)
            sdk_url: "https://downloads.openwrt.org/releases/23.05.5/targets/ipq807x/generic"
            use_apk: false
          - type: apk
            name: Snapshot (Qualcommax)
            sdk_url: "https://downloads.openwrt.org/snapshots/targets/qualcommax/ipq60xx"
            use_apk: true

    steps:
      - uses: actions/checkout@v4

      - name: Download Rust Artifact
        uses: actions/download-artifact@v4
        with:
          name: rust-binary-tarball
          path: local_dl/

      - name: Prepare SDK
        run: |
          sudo apt-get update && sudo apt-get install -y zstd
          
          BASE_URL="${{ matrix.sdk_url }}"
          SDK_FILE=$(wget -qO- "$BASE_URL/sha256sums" | grep "sdk" | grep "Linux-x86_64" | head -n 1 | awk '{print $2}' | sed 's/*//g')
          wget -q "$BASE_URL/$SDK_FILE"
          
          echo "Extracting $SDK_FILE..."
          if [[ "$SDK_FILE" == *.zst ]]; then 
            zstd -d "$SDK_FILE" -o sdk.tar
            tar -xf sdk.tar
          else 
            tar -xf "$SDK_FILE"
          fi
          
          # âš ï¸ å…³é”®ä¿®å¤ï¼šç›´æŽ¥æŸ¥æ‰¾è§£åŽ‹åŽçš„ç›®å½•ï¼Œè€Œä¸æ˜¯è§£æž tar å†…å®¹
          # find å‘½ä»¤åªæ‰¾å½“å‰ç›®å½•ä¸‹ä»¥ openwrt-sdk å¼€å¤´çš„æ–‡ä»¶å¤¹
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -n 1)
          
          if [ -z "$EXTRACTED_DIR" ]; then
            echo "âŒ Error: Could not find extracted SDK directory!"
            ls -la
            exit 1
          fi
          
          echo "Moving '$EXTRACTED_DIR' to 'sdk'..."
          mv "$EXTRACTED_DIR" sdk
      - name: Inject Source into SDK
        run: |
          mkdir -p sdk/dl
          cp local_dl/*.tar.gz sdk/dl/
          echo "âœ… Injected Rust binary into sdk/dl/"

      - name: Configure Feeds
        working-directory: ./sdk
        run: |
          sed -i 's|git.openwrt.org/openwrt/openwrt.git|github.com/openwrt/openwrt.git|g' feeds.conf.default
          sed -i 's|git.openwrt.org/feed/packages.git|github.com/openwrt/packages.git|g' feeds.conf.default
          sed -i 's|git.openwrt.org/project/luci.git|github.com/openwrt/luci.git|g' feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Compile Package
        working-directory: ./sdk
        run: |
          ln -s $GITHUB_WORKSPACE/luci-app-athena-led package/luci-app-athena-led
          
          echo "CONFIG_PACKAGE_luci-app-athena-led=m" > .config
          if [ "${{ matrix.use_apk }}" = "true" ]; then
             echo "CONFIG_SIGNED_PACKAGES=y" >> .config
          fi
          
          make defconfig
          make package/luci-app-athena-led/download V=s
          make package/luci-app-athena-led/compile V=s -j$(nproc)

      - name: Upload Package to Release
        uses: softprops/action-gh-release@v1
        with:
          files: sdk/bin/**/luci-app-athena-led*.${{ matrix.type }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
